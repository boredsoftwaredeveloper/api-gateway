server:
  port: ${SERVER_PORT:8080}

spring:
  application:
    name: api-gateway

  # ── Database (used by Flyway only — gateway has no JPA) ──────────
  datasource:
    url: jdbc:postgresql://db.zasidonntwaimayumbks.supabase.co:5432/postgres?sslmode=require
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver

  flyway:
    enabled: true
    locations: classpath:db/migration

  cloud:
    gateway:
      server:
        webflux:
          # ── Global defaults ──────────────────────────────────────────
          default-filters:
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST

          globalcors:
            cors-configurations:
              '[/**]':
                allowed-origins:
                  - "http://localhost:4200"
                  - "https://boredsoftwaredeveloper.xyz"
                  - "https://www.boredsoftwaredeveloper.xyz"
                allowed-methods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                allowed-headers: "*"
                allow-credentials: true
                max-age: 3600

          # ── Route definitions (static — no Eureka needed) ───────────
          routes:
            # Profile Service routes
            - id: profile-service
              uri: ${PROFILE_SERVICE_URL:http://localhost:8081}
              predicates:
                - Path=/api/v1/profiles/**,/api/v1/experiences/**,/api/v1/achievements/**,/api/v1/aspirations/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: profileCircuitBreaker
                    fallbackUri: forward:/fallback/profile

            # Regret Stream Service routes
            - id: regret-stream-service
              uri: ${REGRET_STREAM_URL:http://localhost:8082}
              predicates:
                - Path=/api/v1/feed/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: regretCircuitBreaker
                    fallbackUri: forward:/fallback/regret

            # ── OpenAPI doc routes (for Swagger UI aggregation) ──────
            - id: profile-service-api-docs
              uri: ${PROFILE_SERVICE_URL:http://localhost:8081}
              predicates:
                - Path=/services/profile/api-docs/**
              filters:
                - RewritePath=/services/profile/api-docs(?<segment>/?.*), /api-docs${segment}

            - id: stream-service-api-docs
              uri: ${REGRET_STREAM_URL:http://localhost:8082}
              predicates:
                - Path=/services/stream/api-docs/**
              filters:
                - RewritePath=/services/stream/api-docs(?<segment>/?.*), /api-docs${segment}

# ── Springdoc (aggregated Swagger UI) ──────────────────────────────
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: API Gateway
        url: /v3/api-docs
      - name: Profile Service
        url: /services/profile/api-docs
      - name: Stream Service
        url: /services/stream/api-docs

# ── Supabase Auth ──────────────────────────────────────────────────
supabase:
  url: ${SUPABASE_URL}
  anon-key: ${SUPABASE_ANON_KEY}
  jwt:
    secret: ${SUPABASE_JWT_SECRET}

# ── Actuator ───────────────────────────────────────────────────────
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    gateway:
      access: UNRESTRICTED

# ── Resilience4j Circuit Breaker ───────────────────────────────────
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3
        slow-call-duration-threshold: 5s
        slow-call-rate-threshold: 80
    instances:
      profileCircuitBreaker:
        base-config: default
      regretCircuitBreaker:
        base-config: default
  timelimiter:
    configs:
      default:
        timeout-duration: 5s

# ── Logging ────────────────────────────────────────────────────────
logging:
  level:
    org.springframework.cloud.gateway: INFO
    io.github.resilience4j: INFO
